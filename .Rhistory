import <- list()
#Run this function on every file in the ./import directory
import <- parLapply(cluster,list.files(path = "./research"),function(file) {
#jsonlite function to convert the ndjson file to a dataframe
df <- stream_in(file(paste0("./research/",file)))
#select which columns to keep
df <- df[,c("geo","screen_name", "geo.type", "geo.coordinates")]
return(df)
})
#function called from the data.table library
df <- rbindlist(import)
#Now you can stop the cluster
stopCluster(cluster)
library("data.table")
library("parallel")
library("jsonlite")
#Parallize this process on 16 threads
cluster <- makeCluster(4)
#Export the jsonlite function stream_in to the cluster
clusterExport(cluster,list("stream_in"))
#Create an empty list for the dataframe for each file
import <- list()
#Run this function on every file in the ./import directory
import <- parLapply(cluster,list.files(path = "./research"),function(file) {
#jsonlite function to convert the ndjson file to a dataframe
df <- stream_in(file(paste0("./research/",file)))
#select which columns to keep
#df <- df[,c("geo","screen_name", "geo.type", "geo.coordinates")]
return(df)
})
#function called from the data.table library
df <- rbindlist(import)
#Now you can stop the cluster
stopCluster(cluster)
View(import)
df <- import[[1]]
View(df)
df1 <- df %>% select(geo)
library(tidyverse)
df1 <- df %>% select(geo)
View(df1)
length(import)
df1 <- df %>% subset(geo.type = "Point")
df1 <- df %>% subset(geo.type = "Point") %>% select(geo)
View(df1)
df1 <- df %>% select(geo) %>% subset(geo.type = "Point")
View(df1)
df2 <- df1 %>% subset(geo.type = "Point")
View(df1)
df2 <- df1[complete.cases(df1), ]
df1 <- df1[complete.cases(df1), ]
df1 <- as.data.frame(df1)
df1 <- df1[complete.cases(df1), ]
df2 <- df1 %>% subset(geo.type = "Point")
View(df1)
summary(df1)
df3 <- as.array(df1$coordinates)
df1 <- df1[complete.cases(df1$coordinates), ]
df1 <- df1$coordinates[complete.cases(df1$coordinates), ]
df1 <- df %>% select(geo.coordinates) %>% subset(geo.type = "Point")
df1 <- df %>% select(geo$coordinates) %>% subset(geo.type = "Point")
df2$geo.coordinates <- as.string(df2$geo.coordinates)
df2$geo.coordinates <- as.factor(df2$geo.coordinates)
df2$geo.coordinates <- as.array(df2$geo.coordinates)
df2 <- as.array(df2$geo.coordinates)
df2$geo.coordinates
coords <- select(df, coordinates.coordinates.1, coordinates.coordinates.0, coordinates.type, user.id)
View(import)
View(import)
df <- import[[1$geo]]
View(df)
df2 <- df[["geo"]]
View(df2)
df3 <- df2[["coordinates"]]
View(df3)
df4 <- as.data.frame(df3)
df4 <- as.array(df3)
View(df4)
df2 <- df[["coordinates"]]
View(df2)
df3 <- df[["geo"]]
View(df2)
df5 <- data.frame(matrix(unlist(df2), nrow=length(df2), byrow=T))
View(df5)
df5 <- data.frame(matrix(unlist(df2), nrow=length(df2), byrow=F))
df6 <- data.frame(matrix(unlist(df2), nrow=length(df2), byrow=F))
df10 <- do.call(rbind.data.frame, df2)
View(df10)
?unlist
View(df5)
View(df2)
View(df2)
df3 <- df2[[31]]
df3 <- df2[[31,]]
df3 <- df2[31]
df3 <- df2[31,]
View(df3)
df4 <- as.data.frame(df3)
View(df4)
df4$coordinates <- separate(df4$coordinates)
df4$coordinates <- unlist(df4$coordinates)
df4$coordinates <- unlist(df4$coordinates, byrow=T)
df4 <- unlist(df4)
df4 <- unlist(df2)
df4 <- unlist(df3)
df4 <- as.data.frame(unlist(df3))
View(df4)
df4 <- as.data.frame(unlist(df2))
df4 <- as.data.frame(unlist(df3))
View(df4)
df4 <- t(df4)
df4 <- as.data.frame(t(df4))
View(df4)
df4 <- as.data.frame(t(df4))
View(df4)
df4 <- as.data.frame(unlist(df2))
df4 <- as.data.frame(t(df4))
View(df4)
df4 <- as.data.frame(t(df4))
View(df4)
df2 <- df[["coordinates"]]
View(df2)
df4 <- as.data.frame(unlist(df2))
df1 <- df1[complete.cases(df2), ]
clean_data <- lapply(data_in, function(df2) x[complete.cases(x),])
library(lapply)
clean_data <- Map(na.omit, df2)
View(clean_data)
View(import)
library(tidyverse)
library(rvest)
library(goalmodel)
library(scales)
library(stringr)
setwd("~/Google Drive/Futbol")
############################
######## No. of Sims #######
############################
i.sim = 100000
xi.set = 0.0025
############################
######### Functions ########
############################
####### Simulate Seasons
### x: schedule with probabilities
### y: current table with points
### z: number of simulations
### simseason(predictions, table.all, 10000)
simseason <- function(x, y, z) {
preds <- x
table.all <- y
nsim <- z
preds = data.frame(preds, round = rep(1:nsim, each = nrow(preds)))
preds$sim <- runif((nrow(preds)),0,1)
preds <- mutate(preds, team1.points = ifelse(sim < p1, 3,
ifelse(sim > (1-p2), 0, 1)))
preds <- mutate(preds, team2.points = ifelse(team1.points == 0, 3,
ifelse(team1.points == 3, 0, 1)))
temp1 <- preds %>% select(team1, team1.points, round) %>% group_by(round, team1) %>% summarize(points = sum(team1.points))
temp2 <- preds %>% select(team2, team2.points, round) %>% group_by(round, team2) %>% summarize(points = sum(team2.points))
colnames(temp1)[2] <- 'team'
colnames(temp2)[2] <- 'team'
preds <- rbind(temp1, temp2)
preds <- preds %>% group_by(team, round) %>% summarize(points = sum(points))
preds <- preds %>% left_join(table.all, by = "team")
preds$points <- preds$points.x + preds$points.y
preds <- preds %>% select(-points.x, -points.y)
preds <- preds[order(-preds$gd),]
preds <- preds[order(-preds$points),]
preds <- preds[order(preds$round),]
preds$rank <- rep(1:nrow(table.all), (nrow(preds)/nrow(table.all)))
all.sims <- preds %>% select(-round)
return(all.sims)
}
####### Rerun Evolution Data
### x: previous results with scores
### y: schedule of upcoming games
### evorerun(results, schedule)
evorerun <- function(x, y){
all.projs <- NA
orig.results <- x
orig.schedule <- y
for (i in 12:max(results$week)){
# Select weeks
results.temp <- orig.results %>% subset(week < (i+1))
results.other <- orig.results %>% subset(week > (i))
results <- results.temp
results.other <- results.other %>% select(home, away, week)
schedule <- rbind(orig.schedule, results.other)
# Dixon-Coles Ratings Model
weights <- weights_dc(results$date, xi=xi.set)
gm_res <- goalmodel(goals1 = results$home.score, goals2 = results$away.score,
team1 = results$home, team2=results$away, weights = weights, rs=TRUE)
# Dixon-Coles Game-by-Game Predictions
predictions <- predict_result(gm_res, team1=schedule$home, team2=schedule$away, return_df = TRUE)
# Add week back
games$key <- paste(games$home, games$away, sep="")
predictions$key <- paste(predictions$team1, predictions$team2, sep="")
predictions <- predictions %>% left_join(games, by = "key") %>% select(week, team1, p1, pd, p2, team2)
# Current Table
table <- results
table <- mutate(table, home.points = ifelse(home.score > away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table <- mutate(table, away.points = ifelse(home.score < away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table.home <- table %>% group_by(home) %>%
summarize(points = sum(home.points))
table.away <- table %>% group_by(away) %>%
summarize(points = sum(away.points))
colnames(table.home)[1] <- 'team'
colnames(table.away)[1] <- 'team'
table.all <- rbind(table.home, table.away)
table.all <- table.all %>% group_by(team) %>%
summarize(points = sum(points))
# Predicted Points
predictions$home.points <- (predictions$p1 * 3) + predictions$pd
predictions$away.points <- (predictions$p2 * 3) + predictions$pd
pred.home <- predictions %>% group_by(team1) %>%
summarize(points = sum(home.points))
pred.away <- predictions %>% group_by(team2) %>%
summarize(points = sum(away.points))
colnames(pred.home)[1] <- 'team'
colnames(pred.away)[1] <- 'team'
pred.all <- rbind(pred.home, pred.away)
pred.all <- pred.all %>% group_by(team) %>%
summarize(points = sum(points))
# Full Projection
proj <- rbind(pred.all, table.all)
proj <- proj %>% group_by(team) %>%
summarize(points = sum(points))
proj$round <- i
all.projs <- rbind(all.projs, proj)
}
all.projs <- all.projs[complete.cases(all.projs), ]
return(all.projs)
}
####### Update Evolution Data
### x: previous results with scores
### y: schedule of upcoming games
### z: saved evolution data csv
### evoupdate(results, schedule, prev.projs)
evoupdate <- function(x, y, z){
all.projs <- NA
orig.results <- x
orig.schedule <- y
prev.projs <- z
for (i in (max(prev.projs$round)-2):max(results$week)){
# Select weeks
results.temp <- orig.results %>% subset(week < (i+1))
results.other <- orig.results %>% subset(week > (i))
results <- results.temp
results.other <- results.other %>% select(home, away, week)
schedule <- rbind(orig.schedule, results.other)
# Dixon-Coles Ratings Model
weights <- weights_dc(results$date, xi=xi.set)
gm_res <- goalmodel(goals1 = results$home.score, goals2 = results$away.score,
team1 = results$home, team2=results$away, weights = weights, rs=TRUE)
# Dixon-Coles Game-by-Game Predictions
predictions <- predict_result(gm_res, team1=schedule$home, team2=schedule$away, return_df = TRUE)
# Add week back
games$key <- paste(games$home, games$away, sep="")
predictions$key <- paste(predictions$team1, predictions$team2, sep="")
predictions <- predictions %>% left_join(games, by = "key") %>% select(week, team1, p1, pd, p2, team2)
# Current Table
table <- results
table <- mutate(table, home.points = ifelse(home.score > away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table <- mutate(table, away.points = ifelse(home.score < away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table.home <- table %>% group_by(home) %>%
summarize(points = sum(home.points))
table.away <- table %>% group_by(away) %>%
summarize(points = sum(away.points))
colnames(table.home)[1] <- 'team'
colnames(table.away)[1] <- 'team'
table.all <- rbind(table.home, table.away)
table.all <- table.all %>% group_by(team) %>%
summarize(points = sum(points))
# Predicted Points
predictions$home.points <- (predictions$p1 * 3) + predictions$pd
predictions$away.points <- (predictions$p2 * 3) + predictions$pd
pred.home <- predictions %>% group_by(team1) %>%
summarize(points = sum(home.points))
pred.away <- predictions %>% group_by(team2) %>%
summarize(points = sum(away.points))
colnames(pred.home)[1] <- 'team'
colnames(pred.away)[1] <- 'team'
pred.all <- rbind(pred.home, pred.away)
pred.all <- pred.all %>% group_by(team) %>%
summarize(points = sum(points))
# Full Projection
proj <- rbind(pred.all, table.all)
proj <- proj %>% group_by(team) %>%
summarize(points = sum(points))
proj$round <- i
all.projs <- rbind(all.projs, proj)
}
all.projs <- all.projs[complete.cases(all.projs), ]
all.projs <- rbind(all.projs, prev.projs)
unique_rows <- !duplicated(all.projs[c("team","round")])
all.projs <- all.projs[unique_rows,]
return(all.projs)
}
####### Recode dates
### x: 'results' dateframe
### daterecode(results)
daterecode <- function(x){
results <- x
results <- results %>% separate(date, c("day", "month", "year"))
results$year <- as.numeric(results$year) + 2000
month.recode <- NA
month.recode$month <- c("Ago", "Sep", "Oct", "Nov", "Dic", "Ene", "Feb", "Mar", "Abr", "May")
month.recode <- as.data.frame(month.recode)
month.recode$month.num <- c(8,9,10,11,12,1,2,3,4,5)
month.recode <- month.recode %>% select(month, month.num)
results <- results %>% left_join(month.recode, by = "month")
results$date <- as.Date(with(results, paste(year, month.num, day,sep="-")), "%Y-%m-%d")
results <- results %>% select(-day, -month, -year, -month.num)
return(results)
}
####### Calculate predicted GD
### x: 'goal.preds' dateframe
### y: 'results' dateframe
### gdcalc(goal.preds, results)
gdcalc <- function(x, y){
goal.preds <- x
results <- y
# GF
pgf.home <- goal.preds %>% group_by(team1) %>%
summarize(gf = sum(expg1))
pgf.away <- goal.preds %>% group_by(team2) %>%
summarize(gf = sum(expg2))
colnames(pgf.home)[1] <- 'team'
colnames(pgf.away)[1] <- 'team'
gf.home <- results %>% group_by(home) %>%
summarize(gf = sum(home.score))
gf.away <- results %>% group_by(away) %>%
summarize(gf = sum(away.score))
colnames(gf.home)[1] <- 'team'
colnames(gf.away)[1] <- 'team'
gf <- rbind(pgf.home, pgf.away, gf.home, gf.away)
gf <- gf %>% group_by(team) %>%
summarize(gf = sum(gf))
# GA
pga.home <- goal.preds %>% group_by(team1) %>%
summarize(ga = sum(expg2))
pga.away <- goal.preds %>% group_by(team2) %>%
summarize(ga = sum(expg1))
colnames(pga.home)[1] <- 'team'
colnames(pga.away)[1] <- 'team'
ga.home <- results %>% group_by(home) %>%
summarize(ga = sum(away.score))
ga.away <- results %>% group_by(away) %>%
summarize(ga = sum(home.score))
colnames(ga.home)[1] <- 'team'
colnames(ga.away)[1] <- 'team'
ga <- rbind(pga.home, pga.away, ga.home, ga.away)
ga <- ga %>% group_by(team) %>%
summarize(ga = sum(ga))
# GD
gd <- gf %>% left_join(ga, by = "team")
gd$gd <- gd$gf - gd$ga
gd <- gd %>% select(team, gd)
return(gd)
}
####### Build current table
### x: 'results' dateframe
### currenttable(results)
currenttable <- function(x){
table <- x
table <- mutate(table, home.points = ifelse(home.score > away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table <- mutate(table, away.points = ifelse(home.score < away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table.home <- table %>% group_by(home) %>%
summarize(points = sum(home.points))
table.away <- table %>% group_by(away) %>%
summarize(points = sum(away.points))
colnames(table.home)[1] <- 'team'
colnames(table.away)[1] <- 'team'
table.all <- rbind(table.home, table.away)
table.all <- table.all %>% group_by(team) %>%
summarize(points = sum(points))
return(table.all)
}
####### Team ratings vs. average
### x: 'table.all' dateframe
### y: 'gm_res' model
### teamrates(table.all, gm_res)
teamrates <- function(x,y){
table.all <- x
gm_res <- y
rate.sked <- table.all %>% select(team)
rate.sked$team2 <- "nobody"
n <- nrow(rate.sked)+1
gm_res_test <- gm_res
gm_res_test$parameters$attack[n] <- 0
names(gm_res_test$parameters$attack[n]) <- c("nobody")
newnames <- names(gm_res_test$parameters$attack)
newnames[n] <- "nobody"
names(gm_res_test$parameters$attack) <- newnames
gm_res_test$parameters$defense[n] <- 0
newnames <- names(gm_res_test$parameters$defense)
newnames[n] <- "nobody"
names(gm_res_test$parameters$defense) <- newnames
gm_res_test$all_teams[n] <- "nobody"
rate.preds <- predict_expg(gm_res_test, team1=rate.sked$team, team2=rate.sked$team2, return_df = TRUE)
rate.preds.away <- predict_expg(gm_res_test, team1=rate.sked$team2, team2=rate.sked$team, return_df = TRUE)
rate.preds.away$team1 <- rate.preds.away$team2
rate.preds <- rate.preds %>% select(-team2) %>% left_join(rate.preds.away, by = "team1")
rate.preds$expg1 <- (rate.preds$expg1.x + rate.preds$expg2.y)/2
rate.preds$expg2 <- (rate.preds$expg2.x + rate.preds$expg1.y)/2
ratings <- rate.preds %>% select(team1, expg1, expg2) %>% rename(
team = team1,
off.rank = expg1,
def.rank = expg2
)
return(ratings)
}
############################
####
###### Primera
# Scrape data
url <- 'https://www.resultados-futbol.com/primera2020/grupo1/calendario'
webpage <- read_html(url)
local_data <- html_nodes(webpage,'.equipo1') %>%  html_nodes("a") %>% html_attr("href")
vist_data <- html_nodes(webpage,'.equipo2') %>%  html_nodes("a") %>% html_attr("href")
result_data <- html_nodes(webpage,'.url') %>% html_text()
dates_data <- html_nodes(webpage,'.fecha') %>% html_text()
# Create data frame
games <- data.frame(home1 = local_data, away1 = vist_data, score = result_data, date = dates_data)
home.names <- read.csv("clubnames.csv") %>% select(home1, home)
away.names <- read.csv("clubnames.csv") %>% select(away1, away)
games <- games %>% left_join(home.names, by = "home1") %>% left_join(away.names, by = "away1") %>% select(home, away, score, date)
games$week <- rep(1:38, each = 10)
schedule1 <- subset(games, grepl("x", games$score))
schedule2 <- subset(games, grepl(":", games$score))
schedule <- rbind(schedule2, schedule1)
schedule <- schedule %>% select(-score, -date)
schedule <- schedule[order(schedule$week),]
results <- subset(games, grepl("-", games$score))
results <- subset(results, !grepl("x", results$score))
results <- results %>% separate(score, c("home.score", "away.score"))
results$home.score <- as.numeric(results$home.score)
results$away.score <- as.numeric(results$away.score)
# Create date variable
results <- daterecode(results)
# Dixon-Coles Ratings Model
weights <- weights_dc(results$date, xi=xi.set)
gm_res <- goalmodel(goals1 = results$home.score, goals2 = results$away.score,
team1 = results$home, team2=results$away, weights = weights, rs=TRUE)
# Dixon-Coles Game-by-Game Predictions
predictions <- predict_result(gm_res, team1=schedule$home, team2=schedule$away, return_df = TRUE)
# Add week back
games$key <- paste(games$home, games$away, sep="")
predictions$key <- paste(predictions$team1, predictions$team2, sep="")
predictions <- predictions %>% left_join(games, by = "key") %>% select(week, team1, p1, pd, p2, team2)
## Calculate Predicated GD
goal.preds <- predict_expg(gm_res, team1=schedule$home, team2=schedule$away, return_df = TRUE)
gd <- gdcalc(goal.preds, results)
# Current Table
table.all <- currenttable(results)
table.all <- table.all %>% left_join(gd, by = "team")
# Team Ratings vs. Average
ratings <- teamrates(table.all, gm_res)
# Simulation (6/7)
all.sims <- simseason(predictions, table.all, i.sim)
## Combine Results Into Final Table
final <- ratings %>% select(team, off.rank, def.rank)
final <- final %>% left_join(gd, by = "team")
proj.points <- all.sims %>% group_by(team) %>% summarize(proj.points = mean(points))
final <- final %>% left_join(proj.points, by = "team")
champ <- all.sims %>% filter(rank == 1) %>% group_by(team) %>% count
champ$champ.pct <- (champ$n/i.sim)
champ <- champ %>% select(-n)
final <- final %>% left_join(champ, by = "team")
playoff <- all.sims %>% filter(rank < 5) %>% group_by(team) %>% count
playoff$playoff.pct <- (playoff$n/i.sim)
playoff <- playoff %>% select(-n)
final <- final %>% left_join(playoff, by = "team")
drop <- all.sims %>% filter(rank > 17 ) %>% group_by(team) %>% count
drop$drop.pct <- (drop$n/i.sim)
drop <- drop %>% select(-n)
final <- final %>% left_join(drop, by = "team")
final[is.na(final)] <- 0
final <- final %>%
mutate(champ.pct = percent(champ.pct, 2)) %>%
mutate(drop.pct = percent(drop.pct, 2)) %>%
mutate(playoff.pct = percent(playoff.pct, 2))
final <- final %>% select(team, proj.points, gd, champ.pct, playoff.pct, drop.pct, off.rank, def.rank)
final$champ.pct <- str_replace(final$champ.pct, "\\b0%", "<1%")
final$champ.pct <- str_replace(final$champ.pct, "100%", ">99%")
final$drop.pct <- str_replace(final$drop.pct, "\\b0%", "<1%")
final$drop.pct <- str_replace(final$drop.pct, "100%", ">99%")
final$playoff.pct <- str_replace(final$playoff.pct, "\\b0%", "<1%")
final$playoff.pct <- str_replace(final$playoff.pct, "100%", ">99%")
final.primera <- final[order(-final$proj.points),]
partits.primera <- predictions %>% mutate(p1 = percent(p1, 2)) %>%
mutate(pd = percent(pd, 2)) %>%
mutate(p2 = percent(p2, 2))
write.csv(final.primera, "final-primera.csv", row.names = FALSE)
write.csv(partits.primera, "games-primera.csv", row.names = FALSE)
# Evolucio Table (6/7)
all.projs <- evorerun(results, schedule)
#prev.projs <- read.csv("prog-primera.csv")
#all.projs <- evoupdate(results, schedule, prev.projs)
write.csv(all.projs, "prog-primera.csv", row.names = FALSE)
library(blogdown)
library(rmarkdown)
setwd("~/Google Drive/Futbol/futstatcat")
render_site()
serve_site()
