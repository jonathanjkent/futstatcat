# Income Inequality ####
## Plots
ggplot(tracts,aes(gni,bt_vs_tw)) + geom_point() + geom_smooth(method = "lm")
ggplot(gni,aes(gni)) + geom_density()
## Models
summary(lm(bt_vs_tw ~ scale(gni) + NCA, data = tracts))
## Models
summary(lm(bt_vs_tw ~ scale(gni), data = tracts))
## Models
summary(lm(bt_vs_tw ~ scale(renta_persona), data = tracts))
library(lme4)
## Models
summary(lm(bt_vs_tw ~ scale(gni) + scale(renta_persona), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NCA), data = tracts))
library(lmerTest)
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NCA), data = tracts))
library(rstanarm)
## Models
summary(stan_lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NCA), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NCA), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NPROV), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NPRO), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NMUN/NPRO), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NPRO/NMUN), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NCA/NPRO/NMUN), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(gni) + scale(renta_persona) + (1 | NCA/NMUN), data = tracts))
## Models
summary(lmer(bt_vs_pop ~ scale(gni) + scale(renta_persona) + (1 | NCA/NMUN), data = tracts))
5.114e-02
## Models
summary(lmer(bt_vs_pop ~ scale(gni) + scale(renta_persona) + (1 | NCA/NPRO/NMUN), data = tracts))
## Models
summary(lmer(bt_vs_pop ~ scale(gni) + scale(renta_persona) + (1 | NMUN), data = tracts))
## Models
summary(lmer(bt_vs_pop ~ scale(gni) + scale(renta_persona) + (1 | NPRO/NMUN), data = tracts))
## Models
summary(lmer(bt_vs_pop ~ scale(gni) + scale(renta_persona) + (1 | NCA/NPRO/NMUN), data = tracts))
## Models
summary(lmer(bt_vs_tw ~ scale(renta_persona) + (1 | NCA/NPRO/NMUN), data = tracts))
summary(lmer(bt_vs_pop ~ scale(renta_persona) + (1 | NCA/NPRO/NMUN), data = tracts))
summary(lmer(bt_count ~ scale(renta_persona) + tw_count + population + (1 | NCA/NPRO/NMUN), data = tracts))
summary(glmer(bt_count ~ scale(renta_persona) + tw_count + population + (1 | NCA/NPRO/NMUN), data = tracts, family = "negbin"))
summary(glmer(bt_count ~ scale(renta_persona) + tw_count + population + (1 | NCA/NPRO/NMUN), data = tracts, family = "negbin")))
summary(glmer(bt_count ~ scale(renta_persona) + tw_count + population + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson")))
summary(glmer(bt_count ~ scale(renta_persona) + tw_count + population + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson"))
summary(glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson"))
summary(glmer(bt_count ~ scale(renta_persona) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson"))
m <- glmer(bt_count ~ scale(renta_persona) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson")
m_tw <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson")
aic(m)
aik(m)
AIC(m)
AIC(m_tw)
anova(m,m_tw)
ggplot(tracts,aes(bt_count)) + geom_density()
table(tracts$bt_count)
m_tw_gini <- glmer(bt_count ~ scale(renta_persona) + scale(gni) + scale(tw_count) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson")
summary(m_tw_gini)
anova(m,m_tw,m_tw_gini)
anova(m_tw,m_tw_gini)
AIC(m_tw_gini)
m_tw <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts[!is.na(tracts$gni)], family = "poisson")
m_tw <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts[!is.na(tracts$gni),], family = "poisson")
anova(m_tw,m_tw_gini)
m_tw_gini <- glmer(bt_count ~ scale(renta_persona) + scale(gni) + scale(tw_count) + scale(population) + (1 | NCA/NPRO/NMUN), data = tracts[!is.na(tracts$gni),], family = "poisson")
anova(m_tw,m_tw_gini)
names(tracts)
m_tw__gini_area <- glmer(bt_count ~ scale(renta_persona) + scale(gni) + scale(tw_count) + scale(population) + scale(Shape_area)+ (1 | NCA/NPRO/NMUN), data = tracts[!is.na(tracts$gni),], family = "poisson")
anova(m_tw_gini,m_tw__gini_area)
summary(m_tw__gini_area)
names(tracts)
tracts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
tracts <- st_transform(tracts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
population <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población) %>% separate(X1, c("CUSEC"))%>% mutate(population = as.numeric(str_replace_all(Población,"[.]", ""))) %>% select(-Población) %>% na.omit()
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5) %>% select(X1,"Renta neta media por persona " ) %>% separate(X1, c("CUSEC")) %>% rename(renta_persona = "Renta neta media por persona " ) %>% mutate(renta_persona = as.numeric(str_replace_all(renta_persona,"[.]", ""))) %>% na.omit()
gini <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/37677.csv", delim = ";", skip = 5) %>% select(X1,"Índice de Gini" ) %>% separate(X1, c("CUSEC")) %>% rename(gini = "Índice de Gini" ) %>% mutate(gini = as.numeric(str_replace_all(gini,"[,]", "."))) %>% na.omit()
tracts <- tracts %>% left_join(income, by = "CUSEC") %>% left_join(population, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
tracts$bt_count <- lengths(st_intersects(tracts, sample_points))
tweets <- read_csv("~/research/tweets_jul1_sep15.csv")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
tracts$tw_count <- lengths(st_intersects(tracts, tweets))
tracts <- tracts %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <- tracts %>% group_by(NMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), renta_persona = weighted.mean(renta_persona, w = population, na.rm = T), gini = weighted.mean(gini, w = population, na.rm = T), population = sum(population, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
m2 <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = munis, family = "poisson")
m2 <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = munis, family = "poisson")
summsummarise())
summary(m2)
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = munis, family = "poisson"))
## Models
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson"))
# Vaccination
source("~/Google Drive/C19/vacprogress.R")
# FutStat.cat
source("~/Google Drive/Futbol/futstat.R")
library(tidyverse)
library(sf)
library(lme4)
library(lmerTest)
library(rstanarm)
sample_points <- st_read("~/research/time_wt_sample_points.shp")
# Tract/Muni Aggregation ####
## Tract level, population and tweet baselines, with income
tracts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
tracts <- st_transform(tracts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
population <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población) %>% separate(X1, c("CUSEC"))%>% mutate(population = as.numeric(str_replace_all(Población,"[.]", ""))) %>% select(-Población) %>% na.omit()
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5) %>% select(X1,"Renta neta media por persona " ) %>% separate(X1, c("CUSEC")) %>% rename(renta_persona = "Renta neta media por persona " ) %>% mutate(renta_persona = as.numeric(str_replace_all(renta_persona,"[.]", ""))) %>% na.omit()
gini <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/37677.csv", delim = ";", skip = 5) %>% select(X1,"Índice de Gini" ) %>% separate(X1, c("CUSEC")) %>% rename(gini = "Índice de Gini" ) %>% mutate(gini = as.numeric(str_replace_all(gini,"[,]", "."))) %>% na.omit()
tracts <- tracts %>% left_join(income, by = "CUSEC") %>% left_join(population, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
tracts$bt_count <- lengths(st_intersects(tracts, sample_points))
tweets <- read_csv("~/research/tweets_jul1_sep15.csv")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
tracts$tw_count <- lengths(st_intersects(tracts, tweets))
tracts <- tracts %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <- tracts %>% group_by(NMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), renta_persona = weighted.mean(renta_persona, w = population, na.rm = T), gini = weighted.mean(gini, w = population, na.rm = T), population = sum(population, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5)
View(demography)
names(demography)
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años,Porcentaje de hogares unipersonales")
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años","Porcentaje de hogares unipersonales")
View(demography)
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años","Tamaño medio del hogar") %>% separate(X1, c("CUSEC")) %>% rename(population = "Población", under_18 = "Porcentaje de población menor de 18 años", over_65 = "Porcentaje de población de 65 y más años", household_size = "Tamaño medio del hogar")
View(demography)
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años","Tamaño medio del hogar") %>% separate(X1, c("CUSEC")) %>% rename(population = "Población", under_18 = "Porcentaje de población menor de 18 años", over_65 = "Porcentaje de población de 65 y más años", household_size = "Tamaño medio del hogar") %>% mutate(population = as.numeric(str_replace_all(population,"[.]", "")), under_18 = as.numeric(str_replace_all(under_18,"[.]", "")), over_65 = as.numeric(str_replace_all(over_65,"[.]", "")), household_size = as.numeric(str_replace_all(household_size,"[.]", ""))) %>% na.omit()
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años","Tamaño medio del hogar") %>% separate(X1, c("CUSEC")) %>% rename(population = "Población", under_18 = "Porcentaje de población menor de 18 años", over_65 = "Porcentaje de población de 65 y más años", household_size = "Tamaño medio del hogar") %>% mutate(population = as.numeric(str_replace_all(population,"[.]", "")), under_18 = as.numeric(str_replace_all(under_18,"[.]", "")), over_65 = as.numeric(str_replace_all(over_65,"[.]", "")), household_size = as.numeric(str_replace_all(household_size,"[.]", ""))) %>% filter(as.numeric(CUSEC) > 0)
View(demography)
summary(demography)
tracts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
tracts <- st_transform(tracts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años","Tamaño medio del hogar") %>% separate(X1, c("CUSEC")) %>% rename(population = "Población", under_18 = "Porcentaje de población menor de 18 años", over_65 = "Porcentaje de población de 65 y más años", household_size = "Tamaño medio del hogar") %>% mutate(population = as.numeric(str_replace_all(population,"[.]", "")), under_18 = as.numeric(str_replace_all(under_18,"[.]", "")), over_65 = as.numeric(str_replace_all(over_65,"[.]", "")), household_size = as.numeric(str_replace_all(household_size,"[.]", ""))) %>% filter(as.numeric(CUSEC) > 0)
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5) %>% select(X1,"Renta neta media por persona " ) %>% separate(X1, c("CUSEC")) %>% rename(renta_persona = "Renta neta media por persona " ) %>% mutate(renta_persona = as.numeric(str_replace_all(renta_persona,"[.]", ""))) %>% na.omit()
gini <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/37677.csv", delim = ";", skip = 5) %>% select(X1,"Índice de Gini" ) %>% separate(X1, c("CUSEC")) %>% rename(gini = "Índice de Gini" ) %>% mutate(gini = as.numeric(str_replace_all(gini,"[,]", "."))) %>% na.omit()
tracts <- tracts %>% left_join(income, by = "CUSEC") %>% left_join(population, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
tracts$bt_count <- lengths(st_intersects(tracts, sample_points))
tweets <- read_csv("~/research/tweets_jul1_sep15.csv")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
tracts$tw_count <- lengths(st_intersects(tracts, tweets))
tracts <- tracts %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
View(tracts)
## Models
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + scale(under_18) + scale(over_65) + scale(household_size) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson"))
names(tracts)
sample_points <- st_read("~/research/time_wt_sample_points.shp")
# Tract/Muni Aggregation ####
## Tract level, population and tweet baselines, with income
tracts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
tracts <- st_transform(tracts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años","Tamaño medio del hogar") %>% separate(X1, c("CUSEC")) %>% rename(population = "Población", under_18 = "Porcentaje de población menor de 18 años", over_65 = "Porcentaje de población de 65 y más años", household_size = "Tamaño medio del hogar") %>% mutate(population = as.numeric(str_replace_all(population,"[.]", "")), under_18 = as.numeric(str_replace_all(under_18,"[.]", "")), over_65 = as.numeric(str_replace_all(over_65,"[.]", "")), household_size = as.numeric(str_replace_all(household_size,"[.]", ""))) %>% filter(as.numeric(CUSEC) > 0)
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5) %>% select(X1,"Renta neta media por persona " ) %>% separate(X1, c("CUSEC")) %>% rename(renta_persona = "Renta neta media por persona " ) %>% mutate(renta_persona = as.numeric(str_replace_all(renta_persona,"[.]", ""))) %>% na.omit()
gini <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/37677.csv", delim = ";", skip = 5) %>% select(X1,"Índice de Gini" ) %>% separate(X1, c("CUSEC")) %>% rename(gini = "Índice de Gini" ) %>% mutate(gini = as.numeric(str_replace_all(gini,"[,]", "."))) %>% na.omit()
tracts <- tracts %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
tracts$bt_count <- lengths(st_intersects(tracts, sample_points))
tweets <- read_csv("~/research/tweets_jul1_sep15.csv")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
tracts$tw_count <- lengths(st_intersects(tracts, tweets))
tracts <- tracts %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
## Models
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + scale(under_18) + scale(over_65) + scale(household_size) + (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson"))
View(tracts)
## Models
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area)+ (1 | NCA/NPRO/NMUN), data = tracts, family = "poisson"))
summary(tracts$household_size)
summary(tracts$under_18)
summary(tracts$over_65)
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5)
View(income)
summary(tracts$renta_persona)
summary(tracts$gini)
View(tracts)
View(tracts)
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <- tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1]) %>% rename(CUSEC = CUMUN)
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <- tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), population = sum(population, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1]) %>% rename(CUSEC = CUMUN) %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <- tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), population = sum(population, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1]) %>% rename(CUSEC = "CUMUN")
View(munis)
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <- tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), population = sum(population, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% rename(CUSEC = "CUMUN") %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
munis <- tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), population = sum(population, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% rename(CUSEC = "CUMUN")
munis
munis <- munis %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
View(income)
View(demography)
tracts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
tracts <- st_transform(tracts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población,"Porcentaje de población menor de 18 años","Porcentaje de población de 65 y más años","Tamaño medio del hogar") %>% separate(X1, c("CUSEC")) %>% rename(population = "Población", under_18 = "Porcentaje de población menor de 18 años", over_65 = "Porcentaje de población de 65 y más años", household_size = "Tamaño medio del hogar") %>% mutate(population = as.numeric(str_replace_all(population,"[.]", "")), under_18 = as.numeric(str_replace_all(under_18,"[.]", "")), over_65 = as.numeric(str_replace_all(over_65,"[.]", "")), household_size = as.numeric(str_replace_all(household_size,"[.]", ""))) %>% filter(as.numeric(CUSEC) > 0)
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5) %>% select(X1,"Renta neta media por persona " ) %>% separate(X1, c("CUSEC")) %>% rename(renta_persona = "Renta neta media por persona " ) %>% mutate(renta_persona = as.numeric(str_replace_all(renta_persona,"[.]", ""))) %>% na.omit()
gini <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/37677.csv", delim = ";", skip = 5) %>% select(X1,"Índice de Gini" ) %>% separate(X1, c("CUSEC")) %>% rename(gini = "Índice de Gini" ) %>% mutate(gini = as.numeric(str_replace_all(gini,"[,]", "."))) %>% na.omit()
tracts <- tracts %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
tracts$bt_count <- lengths(st_intersects(tracts, sample_points))
tweets <- read_csv("~/research/tweets_jul1_sep15.csv")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
tracts$tw_count <- lengths(st_intersects(tracts, tweets))
tracts <- tracts %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <- tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), population = sum(population, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% rename(CUSEC = "CUMUN") %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
colSums(is.na(tracts))
colSums(is.na(munis))
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <-suppressMessage(tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% rename(CUSEC = "CUMUN") %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC"))
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <-suppressMessages(tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% filter(bt_count > 0 & tw_count > 0) %>% rename(CUSEC = "CUMUN") %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC"))
## Models
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, bt_count > 0), family = "poisson"))
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(tracts, bt_count > 0 & population > 0), family = "poisson"))
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(tracts, bt_count > 0), family = "poisson"))
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(tracts, bt_count > 0 & population > 0), family = "poisson"))
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(gini) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(tracts, bt_count > 0 & population > 0), family = "poisson"))
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, bt_count > 0), family = "poisson"))
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(tracts, bt_count > 0 & population > 0), family = "poisson"))
summary(m_wo_tw <- glmer(bt_count ~ scale(renta_persona) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, bt_count > 0), family = "poisson"))
summary(m2_wo_tw <- glmer(bt_count ~ scale(renta_persona) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(tracts, bt_count > 0 & population > 0), family = "poisson"))
anova(m,m_wo_tw)
anova(m2,m2_wo_tw)
summary(m1)
summary(m)
## Models
summary(m <- glmer(scale(bt_count) ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, bt_count > 0), family = "poisson"))
summary(m)
# Inequalities ####
## Plots
ggplot(tracts,aes(bt_count,renta_persona)) + geom_point() + geom_smooth(method = "lm")
# Inequalities ####
## Plots
ggplot(tracts,aes(bt_count,renta_persona)) + geom_point() + geom_smooth()
quantile(tracts$renta_persona)
quantile(tracts$renta_persona, na.rm = T)
q <- quantile(tracts$renta_persona, na.rm = T)
quantile(scale(tracts$renta_persona, na.rm = T))
t_preds <- tibble(renta_persona = quantile(scale(tracts$renta_persona), na.rm = T)
quantile(scale(tracts$renta_persona), na.rm = T)
t_preds <- tibble(renta_persona = quantile(scale(tracts$renta_persona), na.rm = T), income = quantile(tracts$renta_persona, na.rm = T), population = 0, Shape_area = 0, tw_count = 0)
t_preds
predict(m, t_preds)
t_preds <- tibble(renta_persona = quantile(scale(tracts$renta_persona), na.rm = T), income = quantile(tracts$renta_persona, na.rm = T), population = 0, Shape_area = 0, tw_count = 0, NMUN = "Barcelona", NPRO = "Barcelona", NCA = "Cataluña")
predict(m, t_preds)
predict(m,t_preds,se.fit = T)
traceback()
t_preds$pred_count <- predict(m,t_preds)
View(t_preds)
t_preds <- tibble(renta_persona = quantile(scale(tracts$renta_persona), na.rm = T), income = quantile(tracts$renta_persona, na.rm = T), population = 1, Shape_area = 1, tw_count = 1, NMUN = "Barcelona", NPRO = "Barcelona", NCA = "Cataluña")
t_preds$pred_count <- predict(m,t_preds)
View(t_preds)
t_preds$pred_count <- predict(m,t_preds, type = "response")
View(t_preds)
t_preds$pred_count_muni <- predict(m2,t_preds, type = "response")
t_preds <- tibble(renta_persona = quantile(scale(munis$renta_persona), na.rm = T), income = quantile(munis$renta_persona, na.rm = T), population = 1, Shape_area = 1, tw_count = 1, NMUN = "Barcelona", NPRO = "Barcelona", NCA = "Cataluña")
t_preds$pred_count <- predict(m2,t_preds, type = "response")
View(t_preds)
sd(tracts$renta_persona)
sd(tracts$renta_persona,na.rm=T)
summary(m2 <- stan_glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(tracts, bt_count > 0 & population > 0), family = "poisson"))
t_preds <- tibble(renta_persona = quantile(scale(munis$renta_persona), na.rm = T), income = quantile(munis$renta_persona, na.rm = T), population = 0, Shape_area = 0, tw_count = 0, NMUN = "Barcelona", NPRO = "Barcelona", NCA = "Cataluña")
t_preds$pred_count <- exp(predict(m2,t_preds, type = "response"))
View(t_preds)
t_preds$pred_count <- predict(m2,t_preds, type = "response")
mean(munis$bt_count)
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(munis, bt_count > 0 & population > 0), family = "poisson"))
summary(m2_wo_tw <- glmer(bt_count ~ scale(renta_persona) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(munis, bt_count > 0 & population > 0), family = "poisson"))
anova(m2,m2_wo_tw)
t_preds <- tibble(renta_persona = quantile(scale(munis$renta_persona), na.rm = T), income = quantile(munis$renta_persona, na.rm = T), population = 0, Shape_area = 0, tw_count = 0, NMUN = "Barcelona", NPRO = "Barcelona", NCA = "Cataluña")
t_preds <- tibble(renta_persona = quantile(scale(munis$renta_persona), na.rm = T), income = quantile(munis$renta_persona, na.rm = T), population = 0, Shape_area = 0, tw_count = 0, NCA = "Cataluña")
t_preds$pred_count <- predict(m2,t_preds, type = "response")
exp(m$coefficients)
View(m)
summary(m)
exp(m$cnms$beta)
m$cnms$beta
m
exp(m)
m[[1]]
m[[2]]
class(m)
## Models
m <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, bt_count > 0), family = "poisson")
m[1]
m[[1]]
class(m)
library(sjPlot)
plot_model(m)
## Models
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, tw_count > 0), family = "poisson"))
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(munis, tw_count > 0 & population > 0), family = "poisson"))
## Models
summary(m <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, population > 0), family = "poisson"))
summary(m2 <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = filter(munis, population > 0), family = "poisson"))
nrow(tracts %>% filter(bt_count == 0))
nrow(tracts %>% filter(bt_count == 0 & tw_count >0 ))
nrow(tracts %>% filter(tw_count > 0))
tw_limit <- tracts %>% filter(tw_count > 0)
mean(tw_limit$bt_count)
sd(tw_limit$bt_count)
sd(tw_limit$bt_count)/mean(tw_limit$bt_count)
var(tw_limit$bt_count)/mean(tw_limit$bt_count)
var(tw_limit$bt_count)
## Models
summary(m <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NPRO/NMUN), data = filter(tracts, tw_count > 0)))
filter(munis, tw_count > 0 | bt_count > 0)
View(munis)
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <-suppressMessages(tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% rename(CUSEC = "CUMUN") %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC"))
sum(munis$bt_count == 0)
### Munis
muni_model_data <- munis %>% select(bt_count,renta_persona,tw_count,population,Shape_area) %>% na.omit()
st_geometry(muni_model_data) <- NULL
sum(muni_model_data$bt_count == 0)
### Munis
muni_model_data <- munis %>% select(bt_count,renta_persona,tw_count,population,Shape_area,NCA) %>% na.omit()
st_geometry(muni_model_data) <- NULL
sum(muni_model_data$bt_count == 0)
summary(m2 <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data))
m2 <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data)
summary(m2)
summary(muni_negbin <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data))
muni_negbin <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data)
muni_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data, family = "poisson")
summary(muni_pois)
round( sum( dpois(x = 0,
lambda = predict(muni_pois, type = "response") ) ) )
sum(muni_model_data$bt_count == 0)
muni_pois <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data)
muni_nb <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data)
traceback()
muni_nb <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) +
scale(Shape_area) + (1 | NCA), data = muni_model_data, family = MASS::negative.binomial(theta = structure(0.0611360804042324, SE = 0.00218346701069961)),
verbose = T)
muni_nb
asfag
print(muni_nb)
library(tidyverse)
library(sf)
library(lme4)
sample_points <- st_read("~/research/time_wt_sample_points.shp")
# Tract/Muni Aggregation ####
## Tract level, population and tweet baselines, with income
tracts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
tracts <- st_transform(tracts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población) %>% separate(X1, c("CUSEC")) %>% rename(population = "Población") %>% mutate(population = as.numeric(str_replace_all(population,"[.]", ""))) %>% filter(as.numeric(CUSEC) > 0)
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5) %>% select(X1,"Renta neta media por persona " ) %>% separate(X1, c("CUSEC")) %>% rename(renta_persona = "Renta neta media por persona " ) %>% mutate(renta_persona = as.numeric(str_replace_all(renta_persona,"[.]", ""))) %>% na.omit()
gini <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/37677.csv", delim = ";", skip = 5) %>% select(X1,"Índice de Gini" ) %>% separate(X1, c("CUSEC")) %>% rename(gini = "Índice de Gini" ) %>% mutate(gini = as.numeric(str_replace_all(gini,"[,]", "."))) %>% na.omit()
tracts <- tracts %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
tracts$bt_count <- lengths(st_intersects(tracts, sample_points))
tweets <- read_csv("~/research/tweets_jul1_sep15.csv")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
tracts$tw_count <- lengths(st_intersects(tracts, tweets))
tracts <- tracts %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <-suppressMessages(tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% rename(CUSEC = "CUMUN") %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC"))
library(MASS)
library(tidyverse)
### Munis
muni_model_data <- munis %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA) %>% na.omit()
st_geometry(muni_model_data) <- NULL
muni_nb <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data)
### Munis
muni_model_data <- munis %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA) %>% na.omit() %>% filter(population > 0)
st_geometry(muni_model_data) <- NULL
muni_nb <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data)
## Models
### Tracts
tract_model_data <- tracts %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA,NPRO,NMUN) %>% na.omit() %>% filter(population > 0)
st_geometry(tract_model_data) <- NULL
tract_nb <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NMUN), data = tract_model_data)
sum(tract_model_data$bt_count == 0)
### Munis
muni_model_data <- munis %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA) %>% na.omit() %>% filter(bt_count > 0 | tw_count > 0)
st_geometry(muni_model_data) <- NULL
muni_nb <- glmer.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data)
muni_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data, family = "poisson")
summary(muni_pois)
# Zero Check
sum(muni_model_data$bt_count == 0)
round(sum(dpois(x = 0,lambda = predict(muni_pois, type = "response"))))
tract_model_data <- tracts %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA,NPRO,NMUN) %>% na.omit() %>% filter(bt_count > 0 | tw_count > 0)
st_geometry(tract_model_data) <- NULL
tract_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NMUN), data = tract_model_data, family = "poisson")
summary(tract_pois)
sum(tract_model_data$bt_count == 0)
round(sum(dpois(x = 0,lambda = predict(tract_pois, type = "response"))))
sum(muni_model_data$bt_count == 0)
round(sum(dpois(x = 0,lambda = predict(muni_pois, type = "response"))))
print(paste0("Zeros in data: ",sum(tract_model_data$bt_count == 0))
)
print(paste0("Zeros in data: ",sum(tract_model_data$bt_count == 0)))
print(paste0("Zeros in predicted by model: ",round(sum(dpois(x = 0,lambda = predict(tract_pois, type = "response"))))))
tract_model_data <- tracts %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA,NPRO,NMUN) %>% na.omit()
st_geometry(tract_model_data) <- NULL
tract_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NMUN), data = tract_model_data, family = "poisson")
summary(tract_pois)
print(paste0("Zeros in data: ",sum(tract_model_data$bt_count == 0)))
print(paste0("Zeros predicted by model: ",round(sum(dpois(x = 0,lambda = predict(tract_pois, type = "response"))))))
muni_model_data <- munis %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA) %>% na.omit()
st_geometry(muni_model_data) <- NULL
muni_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data, family = "poisson")
sum(muni_model_data$bt_count == 0)
round(sum(dpois(x = 0,lambda = predict(muni_pois, type = "response"))))
ggplot() + geom_density(predict(muni_pois, type = "response"))
ggplot() + geom_density(aes(predict(muni_pois, type = "response")))
ggplot() + geom_density(aes(predict(muni_pois, type = "response"))) + geom_density(muni_model_data$bt_count)
ggplot() + geom_density(aes(predict(muni_pois, type = "response"))) + geom_density(aes(muni_model_data$bt_count))
ggplot() + geom_density(aes(predict(muni_pois, type = "response")), color = "red") + geom_density(aes(muni_model_data$bt_count), color = "blue")
muni_nb <- glm.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + NCA, data = muni_model_data)
library(tidyverse)
library(sf)
library(lme4)
sample_points <- st_read("~/research/time_wt_sample_points.shp")
# Tract/Muni Aggregation ####
## Tract level, population and tweet baselines, with income
tracts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
tracts <- st_transform(tracts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
demography <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30832.csv", delim = ";", skip = 5) %>% select(X1,Población) %>% separate(X1, c("CUSEC")) %>% rename(population = "Población") %>% mutate(population = as.numeric(str_replace_all(population,"[.]", ""))) %>% filter(as.numeric(CUSEC) > 0)
income <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/30824.csv", delim = ";", skip = 5) %>% select(X1,"Renta neta media por persona " ) %>% separate(X1, c("CUSEC")) %>% rename(renta_persona = "Renta neta media por persona " ) %>% mutate(renta_persona = as.numeric(str_replace_all(renta_persona,"[.]", ""))) %>% na.omit()
gini <- read_delim("https://ine.es/jaxiT3/files/t/es/csv_sc/37677.csv", delim = ";", skip = 5) %>% select(X1,"Índice de Gini" ) %>% separate(X1, c("CUSEC")) %>% rename(gini = "Índice de Gini" ) %>% mutate(gini = as.numeric(str_replace_all(gini,"[,]", "."))) %>% na.omit()
tracts <- tracts %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC")
tracts$bt_count <- lengths(st_intersects(tracts, sample_points))
tweets <- read_csv("~/research/tweets_jul1_sep15.csv")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
tracts$tw_count <- lengths(st_intersects(tracts, tweets))
tracts <- tracts %>% mutate(bt_vs_tw = scale((bt_count/sum(bt_count, na.rm = T))-(tw_count/sum(tw_count, na.rm = T)))[,1]) %>% mutate(bt_vs_pop = scale((bt_count/sum(bt_count, na.rm = T))-(population/sum(population, na.rm = T)))[,1])
## Municipal level, population and tweet baselines (aggregate pop/income too!)
munis <-suppressMessages(tracts %>% group_by(NMUN,CUMUN,NCA) %>% summarise(bt_count = sum(bt_count, na.rm = T), tw_count = sum(tw_count, na.rm = T), Shape_area = sum(Shape_area, na.rm = T)) %>% ungroup() %>% rename(CUSEC = "CUMUN") %>% left_join(income, by = "CUSEC") %>% left_join(demography, by = "CUSEC") %>% left_join(gini, by = "CUSEC"))
muni_model_data <- munis %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA) %>% na.omit() %>% filter(bt_count > 0 | tw_count > 0)
st_geometry(muni_model_data) <- NULL
muni_nb <- glm.nb(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + NCA, data = muni_model_data)
muni_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data, family = "poisson")
print(paste0("Zeros in data: ",sum(muni_model_data$bt_count == 0)))
print(paste0("Zeros predicted by model: ",round(sum(dpois(x = 0,lambda = predict(muni_pois, type = "response"))))))
tract_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NMUN), data = tract_model_data, family = "poisson")
summary(tract_pois)
print(paste0("Zeros in data: ",sum(tract_model_data$bt_count == 0)))
print(paste0("Zeros predicted by model: ",round(sum(dpois(x = 0,lambda = predict(tract_pois, type = "response"))))))
tract_model_data <- tracts %>% dplyr::select(bt_count,renta_persona,tw_count,population,Shape_area,NCA,NPRO,NMUN) %>% na.omit()
st_geometry(tract_model_data) <- NULL
tract_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA/NMUN), data = tract_model_data, family = "poisson")
summary(tract_pois)
print(paste0("Zeros in data: ",sum(tract_model_data$bt_count == 0)))
print(paste0("Zeros predicted by model: ",round(sum(dpois(x = 0,lambda = predict(tract_pois, type = "response"))))))
muni_model_data <- munis %>% select(bt_count,renta_persona,tw_count,population,Shape_area,NCA) %>% na.omit()
st_geometry(muni_model_data) <- NULL
muni_pois <- glmer(bt_count ~ scale(renta_persona) + scale(tw_count) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data, family = "poisson")
summary(muni_pois)
print(paste0("Zeros in data: ",sum(muni_model_data$bt_count == 0)))
print(paste0("Zeros predicted by model: ",round(sum(dpois(x = 0,lambda = predict(muni_pois, type = "response"))))))
tract_wo_tw <- glmer(bt_count ~ scale(renta_persona) + scale(population) + scale(Shape_area) + (1 | NCA/NMUN), data = tract_model_data, family = "poisson")
muni_wo_tw <- glmer(bt_count ~ scale(renta_persona) + scale(population) + scale(Shape_area) + (1 | NCA), data = muni_model_data, family = "poisson")
anova(tract_pois,tract_wo_tw)
anova(muni_pois,muni_wo_tw)
# Vaccination
source("~/Google Drive/C19/vacprogress.R")
# NYR
source("~/Google Drive/Hockey/nyr.R")
View(nyr)
# FutStat.cat
source("~/Google Drive/Futbol/futstat.R")
# NYR
source("~/Google Drive/Hockey/nyr.R")
source("~/Google Drive/Futbol/tercerafullsim.R")
# FutStat.cat
source("~/Google Drive/Futbol/futstat.R")
library(tidyverse)
seasons <- 2010:2020
pbp <- purrr::map_df(seasons, function(x) {
readRDS(
url(
glue::glue("https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_{x}.rds")
)
)
})
names(pbp)
summary(pbp$air_yards)
deep.balls <- pbp %>% filter(air_yards > 20)
sort(desc(table(deep.balls$passer)))
table(deep.balls$complete_pass)
by.qb <- deep.balls %>% group_by(passer) %>% (deep.pct = mean(complete_pass)) %>% arrange(desc(deep.pct))
by.qb <- deep.balls %>% group_by(passer) %>% summarise(deep.pct = mean(complete_pass)) %>% arrange(desc(deep.pct))
by.qb
by.qb <- deep.balls %>% group_by(passer) %>% summarise(deep.pct = mean(complete_pass), att = count()) %>% arrange(desc(deep.pct))
by.qb <- deep.balls %>% group_by(passer) %>% count() %>% summarise(deep.pct = mean(complete_pass)) %>% arrange(desc(deep.pct))
by.qb <- deep.balls %>% group_by(passer) %>% summarise(deep.pct = mean(complete_pass, att = n())) %>% arrange(desc(deep.pct))
by.qb
by.qb <- deep.balls %>% group_by(passer) %>% summarise(deep.pct = mean(complete_pass), att = n())) %>% arrange(desc(deep.pct))
by.qb <- deep.balls %>% group_by(passer) %>% summarise(deep.pct = mean(complete_pass), att = n()) %>% arrange(desc(deep.pct))
by.qb
by.qb <- deep.balls %>% group_by(passer) %>% summarise(deep.pct = mean(complete_pass), att = n()) %>% filter(att >9) %>% arrange(desc(deep.pct))
by.qb
names(deep.balls)
by.qb <- deep.balls %>% group_by(passer,season) %>% summarise(deep.pct = mean(complete_pass), att = n()) %>% filter(att >9) %>% arrange(desc(deep.pct))
by.qb
by.qb <- deep.balls %>% group_by(passer,season) %>% summarise(deep.pct = mean(complete_pass), att = n()) %>% filter(att > 20) %>% arrange(desc(deep.pct))
by.qb
# Vaccination
source("~/Google Drive/C19/vacprogress.R")
source("~/Google Drive/Futbol/tercerafullsim.R")
# FutStat.cat
source("~/Google Drive/Futbol/futstat.R")
# FutStat.cat
source("~/Google Drive/Futbol/futstat.R")
# Vaccination
source("~/Google Drive/C19/vacprogress.R")
# NYR
source("~/Google Drive/Hockey/nyr.R")
